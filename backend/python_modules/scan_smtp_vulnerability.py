import nmap

def scan_vulnerable_smtp(ip: str, port: int) -> dict:
    """
    Scans a given IP and port for extensive SMTP vulnerabilities using Nmap's NSE scripts.

    Args:
        ip (str): The target IP address to scan.
        port (int): The specific SMTP port to check.

    Returns:
        dict: A dictionary containing detected SMTP vulnerabilities.
    """
    nm = nmap.PortScanner()

    nm.scan(
        hosts=ip, 
        ports=str(port), 
        arguments="--script smtp-vuln*,smtp-enum-users,smtp-open-relay,smtp-strangeport,smtp-commands,smtp-ntlm-info,smtp-brute"
    )

    results = {}
    port=int(port)

    if ip in nm.all_hosts():
        for proto in nm[ip].all_protocols():
            if port in nm[ip][proto]:
                script_results = nm[ip][proto][port].get("script", {})
                if script_results:
                    results[port] = script_results  
    
    return results 

def help():
    """
    Provides usage instructions for the scan_vulnerable_smtp function.

    Example:
        smtp_vulns = scan_vulnerable_smtp("192.168.1.1", 25)
        print(smtp_vulns)

    This scans a given IP and port for SMTP vulnerabilities using Nmap.

    Returns:
        dict: A dictionary containing detected SMTP vulnerabilities.
    """
    help_text = (
        "\nUsage:\n"
        "    Call the function scan_vulnerable_smtp(ip, port) with a valid IP address and port number.\n"
        "    Example:\n"
        "        smtp_vulns = scan_vulnerable_smtp(\"192.168.1.1\", 25)\n"
        "        print(smtp_vulns)\n"
        "    This scans the given IP's SMTP service on the specified port for known vulnerabilities using Nmap NSE scripts.\n"
        "\nFeatures Scanned:\n"
        "    - Checks for common SMTP misconfigurations and known vulnerabilities (smtp-vuln*).\n"
        "    - Detects open mail relay vulnerabilities (smtp-open-relay).\n"
        "    - Enumerates SMTP users (smtp-enum-users).\n"
        "    - Scans for unusual SMTP service ports (smtp-strangeport).\n"
        "    - Retrieves SMTP service commands and versions (smtp-commands).\n"
        "    - Checks for NTLM authentication information leaks (smtp-ntlm-info).\n"
        "    - Performs brute-force testing for weak SMTP credentials (smtp-brute).\n"
        "\nArguments:\n"
        "    ip (str): A valid IPv4 address (e.g., \"192.168.1.1\").\n"
        "    port (int): The SMTP port to scan (default: 25, 465, 587).\n"
        "\nReturns:\n"
        "    dict: A dictionary with detected SMTP vulnerabilities.\n"
        "\nNotes:\n"
        "    - Requires Nmap and SMTP-related NSE scripts to be installed.\n"
        "    - Ensure you have permission before scanning external IPs.\n"
        "    - Supports scanning of non-standard SMTP ports.\n"
    )
    return help_text
