import nmap

def scan_vulnerable_ldap(ip: str, port: int) -> dict:
    """
    Scans a given IP and port for extensive LDAP vulnerabilities using Nmap's NSE scripts.

    Args:
        ip (str): The target IP address to scan.
        port (int): The specific port to check for LDAP vulnerabilities.

    Returns:
        dict: A dictionary containing detected LDAP vulnerabilities.
    """
    nm = nmap.PortScanner()
    
    nm.scan(
        hosts=ip, 
        ports=str(port), 
        arguments=(
            "--script ldap-rootdse,ldap-search,ldap-novell-getpass," 
            "ldap-msad-user,ldap-msad-ds,ldap-strange-dn,ldap-unsupported-extended-ops"
        )
    )
    
    results = {}
    port=int(port)

    if ip in nm.all_hosts():
        for proto in nm[ip].all_protocols():
            if port in nm[ip][proto]:
                script_results = nm[ip][proto][port].get("script", {})
                if script_results:
                    results[port] = script_results
    
    return results

def help():
    """
    Provides usage instructions for the scan_vulnerable_ldap function.

    Example:
        ldap_vulns = scan_vulnerable_ldap("192.168.1.1", 389)
        print(ldap_vulns)

    This scans a specific port on the given IP for LDAP vulnerabilities using enhanced scanning scripts.

    Returns:
        dict: A dictionary containing detected LDAP vulnerabilities.
    """
    help_text = (
        "\nUsage:\n"
        "    Call the function scan_vulnerable_ldap(ip, port) with a valid IP address and port number.\n"
        "    Example:\n"
        "        ldap_vulns = scan_vulnerable_ldap(\"192.168.1.1\", 389)\n"
        "        print(ldap_vulns)\n"
        "\nFeatures Scanned:\n"
        "    - Queries the LDAP RootDSE for useful domain information (ldap-rootdse).\n"
        "    - Searches for exposed directory information (ldap-search).\n"
        "    - Detects Novell LDAP password leaks (ldap-novell-getpass).\n"
        "    - Enumerates Microsoft Active Directory users (ldap-msad-user).\n"
        "    - Detects AD-specific domain and DS information (ldap-msad-ds).\n"
        "    - Identifies anomalous distinguished names (ldap-strange-dn).\n"
        "    - Checks for unsupported extended operations (ldap-unsupported-extended-ops).\n"
        "\nArguments:\n"
        "    ip (str): A valid IPv4 address.\n"
        "    port (int): The LDAP port to scan (default: 389 for standard LDAP, 636 for LDAPS).\n"
        "\nReturns:\n"
        "    dict: A dictionary with detected LDAP vulnerabilities.\n"
        "\nNotes:\n"
        "    - Requires Nmap and LDAP-related NSE scripts to be installed.\n"
        "    - Ensure you have permission before scanning external IPs.\n"
        "    - Supports scanning of non-standard LDAP ports.\n"
    )
    return help_text
