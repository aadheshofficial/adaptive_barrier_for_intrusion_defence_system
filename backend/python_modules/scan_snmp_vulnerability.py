import nmap

def scan_vulnerable_snmp(ip: str, port: int) -> dict:
    """
    Scans a given IP and port for SNMP vulnerabilities using Nmap's NSE scripts.

    Args:
        ip (str): The target IP address to scan.
        port (int): The specific port to check for SNMP vulnerabilities.

    Returns:
        dict: A dictionary containing detected SNMP vulnerabilities.
    """
    nm = nmap.PortScanner()
    nm.scan(
        hosts=ip, 
        ports=str(port), 
        arguments="--script snmp-brute,snmp-hh3c-logins,snmp-info,snmp-interfaces,snmp-netstat,snmp-processes,snmp-sysdescr,snmp-win32-shares,snmp-win32-software,snmp-win32-users"
    )
    
    results = {}
    port=int(port)
    
    if ip in nm.all_hosts():
        for proto in nm[ip].all_protocols():
            if port in nm[ip][proto]:
                script_results = nm[ip][proto][port].get("script", {})
                if script_results:
                    results[port] = script_results
    
    return results

def help():
    """
    Provides usage instructions for the scan_vulnerable_snmp function.

    Example:
        snmp_vulns = scan_vulnerable_snmp("192.168.1.1", 161)
        print(snmp_vulns)

    This scans a specific port on the given IP for SNMP vulnerabilities.

    Returns:
        dict: A dictionary containing detected SNMP vulnerabilities.
    """
    help_text = (
        "\nUsage:\n"
        "    Call the function scan_vulnerable_snmp(ip, port) with a valid IP address and port number.\n"
        "    Example:\n"
        "        snmp_vulns = scan_vulnerable_snmp(\"192.168.1.1\", 161)\n"
        "        print(snmp_vulns)\n"
        "\nFeatures Scanned:\n"
        "    - SNMP brute force attack detection (snmp-brute).\n"
        "    - Detection of weak credentials in H3C devices (snmp-hh3c-logins).\n"
        "    - System and device information leaks (snmp-info, snmp-sysdescr).\n"
        "    - Active network interfaces and routing tables (snmp-interfaces, snmp-netstat).\n"
        "    - Running processes and potential misconfigurations (snmp-processes).\n"
        "    - Windows shares, installed software, and users (snmp-win32-shares, snmp-win32-software, snmp-win32-users).\n"
        "\nArguments:\n"
        "    ip (str): A valid IPv4 address.\n"
        "    port (int): The port number to scan (default SNMP port: 161 for UDP, 162 for SNMP traps).\n"
        "\nReturns:\n"
        "    dict: A dictionary with detected SNMP vulnerabilities.\n"
        "\nNotes:\n"
        "    - Requires Nmap and SNMP-related NSE scripts to be installed.\n"
        "    - Ensure you have permission before scanning external IPs.\n"
        "    - Supports scanning of non-standard SNMP ports.\n"
    )
    return help_text
