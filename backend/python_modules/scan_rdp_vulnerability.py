import nmap

def scan_vulnerable_rdp(ip: str, port: int) -> dict:
    """
    Scans a given IP and port for RDP (Remote Desktop Protocol) vulnerabilities using Nmap's NSE scripts.

    Args:
        ip (str): The target IP address to scan.
        port (int): The specific port to check for RDP vulnerabilities.

    Returns:
        dict: A dictionary containing detected RDP vulnerabilities.
    """
    nm = nmap.PortScanner()
    nm.scan(
        hosts=ip,
        ports=str(port),
        arguments="--script rdp-enum-encryption,rdp-vuln-ms12-020,rdp-ntlm-info,rdp-brute,rdp-security-layer,rdp-bluekeep"
    )

    results = {}
    port=int(port)

    if ip in nm.all_hosts():
        for proto in nm[ip].all_protocols():
            if port in nm[ip][proto]:
                script_results = nm[ip][proto][port].get("script", {})
                if script_results:
                    results[port] = script_results

    return results

def help():
    """
    Provides usage instructions for the scan_vulnerable_rdp function.

    Example:
        rdp_vulns = scan_vulnerable_rdp("192.168.1.1", 3389)
        print(rdp_vulns)

    This scans a given IP and port for RDP vulnerabilities.

    Returns:
        dict: A dictionary containing detected RDP vulnerabilities.
    """
    help_text = (
        "\nUsage:\n"
        "    Call the function scan_vulnerable_rdp(ip, port) with a valid IP address and port number.\n"
        "    Example:\n"
        "        rdp_vulns = scan_vulnerable_rdp(\"192.168.1.1\", 3389)\n"
        "        print(rdp_vulns)\n"
        "    This scans the given IP's RDP service on the specified port for known vulnerabilities using Nmap NSE scripts.\n"
        "\nArguments:\n"
        "    ip (str): A valid IPv4 address (e.g., \"192.168.1.1\").\n"
        "    port (int): The port number to scan (default RDP port: 3389).\n"
        "\nFeatures:\n"
        "    - **rdp-enum-encryption**: Detects weak or missing encryption in RDP.\n"
        "    - **rdp-vuln-ms12-020**: Checks for the **MS12-020 RDP DoS vulnerability** (CVE-2012-0002).\n"
        "    - **rdp-ntlm-info**: Extracts NTLM authentication details (useful for credential attacks).\n"
        "    - **rdp-brute**: Tests for weak RDP credentials via brute-force attack.\n"
        "    - **rdp-security-layer**: Identifies potential MITM risks due to weak security layers.\n"
        "    - **rdp-bluekeep**: Checks if the system is vulnerable to **BlueKeep (CVE-2019-0708)**.\n"
        "\nReturns:\n"
        "    dict: A dictionary with detected RDP vulnerabilities.\n"
        "\nNotes:\n"
        "    - Requires Nmap and NSE scripts to be installed.\n"
        "    - Ensure you have permission before scanning external IPs.\n"
        "    - Works on standard and non-standard RDP ports.\n"
    )
    return help_text
