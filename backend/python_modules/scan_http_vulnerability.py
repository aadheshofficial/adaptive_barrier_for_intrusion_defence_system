import nmap

def scan_vulnerable_http(ip: str, port: int) -> dict:
    """
    Scans a given IP and port for extensive HTTP vulnerabilities using Nmap's NSE scripts.

    Args:
        ip (str): The target IP address to scan.
        port (int): The specific port to check for HTTP vulnerabilities.

    Returns:
        dict: A dictionary containing detected HTTP vulnerabilities.
    """
    nm = nmap.PortScanner()
    
    nm.scan(
        hosts=ip,
        ports=str(port),
        arguments="--script http-vuln*,http-enum,http-auth,http-title,http-methods,http-headers,http-cors,http-robots.txt,http-shellshock,http-dombased-xss,http-sql-injection,http-open-redirect"
    )
    
    results = {}
    port=int(port)
    
    if ip in nm.all_hosts():
        for proto in nm[ip].all_protocols():
            if port in nm[ip][proto]:
                script_results = nm[ip][proto][port].get("script", {})
                if script_results:
                    results[port] = script_results
    
    return results

def help():
    """
    Provides usage instructions for the scan_vulnerable_http function.

    Example:
        http_vulns = scan_vulnerable_http("192.168.1.1", 80)
        print(http_vulns)

    This scans a specific port on the given IP for HTTP vulnerabilities.

    Returns:
        dict: A dictionary containing detected HTTP vulnerabilities.
    """
    help_text = (
        "\nUsage:\n"
        "    Call the function scan_vulnerable_http(ip, port) with a valid IP address and port number.\n"
        "    Example:\n"
        "        http_vulns = scan_vulnerable_http(\"192.168.1.1\", 80)\n"
        "        print(http_vulns)\n"
        "\nFeatures Scanned:\n"
        "    - Enumerates HTTP directories and files (http-enum).\n"
        "    - Detects authentication mechanisms (http-auth).\n"
        "    - Retrieves HTTP headers and identifies security misconfigurations (http-headers).\n"
        "    - Detects Cross-Origin Resource Sharing (CORS) vulnerabilities (http-cors).\n"
        "    - Extracts information from robots.txt (http-robots.txt).\n"
        "    - Scans for Shellshock vulnerability (http-shellshock).\n"
        "    - Identifies possible DOM-based XSS vulnerabilities (http-dombased-xss).\n"
        "    - Detects SQL injection vulnerabilities (http-sql-injection).\n"
        "    - Checks for Local File Inclusion (LFI) vulnerabilities (http-lfi).\n"
        "    - Identifies open redirect vulnerabilities (http-open-redirect).\n"
        "\nArguments:\n"
        "    ip (str): A valid IPv4 address.\n"
        "    port (int): The port number to scan (default HTTP port: 80, HTTPS: 443).\n"
        "\nReturns:\n"
        "    dict: A dictionary with detected HTTP vulnerabilities.\n"
        "\nNotes:\n"
        "    - Requires Nmap and HTTP-related NSE scripts to be installed.\n"
        "    - Ensure you have permission before scanning external IPs.\n"
        "    - Supports scanning of non-standard HTTP ports (e.g., 8080, 8443).\n"
    )
    return help_text
