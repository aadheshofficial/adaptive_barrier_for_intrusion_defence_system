import nmap

def scan_vulnerable_mssql(ip: str, port: int = 1433) -> dict:
    """
    Scans a given IP and port for MSSQL vulnerabilities using Nmap's exclusive NSE scripts.

    Args:
        ip (str): The target IP address to scan.
        port (int): The specific MSSQL port to check (default: 1433).

    Returns:
        dict: A dictionary containing detected MSSQL vulnerabilities.
    """
    nm = nmap.PortScanner()
    scripts = (
        "ms-sql-brute,ms-sql-config,ms-sql-dump-hashes,"
        "ms-sql-empty-password,ms-sql-info,ms-sql-query,"
        "ms-sql-tables,ms-sql-vuln,ssl-enum-ciphers"
    )
    
    try:
        nm.scan(hosts=ip, ports=str(port), arguments=f"--script {scripts} -Pn --open")
        results = {}
        port=int(port)

        if ip in nm.all_hosts():
            for proto in nm[ip].all_protocols():
                if port in nm[ip][proto]:
                    script_results = nm[ip][proto][port].get("script", {})
                    if script_results:
                        results[port] = script_results
                    else:
                        results[port] = "No vulnerabilities detected."
        else:
            results['error'] = "Host is down or unreachable."
    except Exception as e:
        results['error'] = f"Error running scan: {str(e)}"
    
    return results

def help_mssql():
    """
    Provides usage instructions for the scan_vulnerable_mssql function.
    """
    help_text = (
        "\nUsage:\n"
        "    Call the function scan_vulnerable_mssql(ip, port) with a valid IP address and port number.\n"
        "    Example:\n"
        "        mssql_vulns = scan_vulnerable_mssql(\"192.168.1.1\", 1433)\n"
        "        print(mssql_vulns)\n"
        "\nFeatures Scanned:\n"
        "    - Tests for weak/default passwords (ms-sql-brute).\n"
        "    - Retrieves server configuration details (ms-sql-config).\n"
        "    - Dumps password hashes (ms-sql-dump-hashes).\n"
        "    - Detects empty password accounts (ms-sql-empty-password).\n"
        "    - Extracts MSSQL server details (ms-sql-info).\n"
        "    - Executes arbitrary queries if permissions allow (ms-sql-query).\n"
        "    - Enumerates database tables (ms-sql-tables).\n"
        "    - Scans for known MSSQL vulnerabilities (ms-sql-vuln).\n"
        "    - Checks for SSL/TLS misconfigurations (ssl-enum-ciphers).\n"
        "\nArguments:\n"
        "    ip (str): A valid IPv4 address.\n"
        "    port (int): The port number to scan (default: 1433).\n"
        "\nReturns:\n"
        "    dict: A dictionary with detected MSSQL vulnerabilities or error messages.\n"
        "\nNotes:\n"
        "    - Requires Nmap and relevant NSE scripts installed.\n"
        "    - Ensure you have permission before scanning external IPs.\n"
        "    - Supports scanning of non-standard MSSQL ports.\n"
    )
    return help_text
