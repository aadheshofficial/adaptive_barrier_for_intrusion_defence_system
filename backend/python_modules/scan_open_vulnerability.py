import nmap

def scan_vulnerabilities(ip: str) -> dict:
    """
    Scans a given IP for known vulnerabilities using Nmap's NSE vulnerability scripts.

    Args:
        ip (str): The target IP address to scan.

    Returns:
        dict: A dictionary containing detected vulnerabilities for each open port.
    """
    nm = nmap.PortScanner()

    nm.scan(hosts=ip, arguments="--script vuln", timeout=600) 

    results = {}
    port=int(port)

    if ip in nm.all_hosts():
        for proto in nm[ip].all_protocols():
            for port in nm[ip][proto]:
                port_info = nm[ip][proto][port]
                script_results = port_info.get("script", {})

                if script_results:
                    results[port] = script_results  

    return results 

def help():
    """
    Provides usage instructions for the scan_vulnerabilities function.

    Example:
        vulnerabilities = scan_vulnerabilities("192.168.1.1")
        print(vulnerabilities)

    This scans a given IP for known vulnerabilities using Nmap.

    Returns:
        dict: A dictionary containing detected vulnerabilities for each open port.
    """
    help_text = (
        "\nUsage:\n"
        "    Call the function scan_vulnerabilities(ip) with a valid IP address.\n"
        "    Example:\n"
        "        vulnerabilities = scan_vulnerabilities(\"192.168.1.1\")\n"
        "        print(vulnerabilities)\n"
        "    This scans the given IP for known vulnerabilities using Nmap NSE scripts.\n"
        "\nArguments:\n"
        "    ip (str): A valid IPv4 address (e.g., \"192.168.1.1\").\n"
        "\nReturns:\n"
        "    dict: A dictionary with port numbers as keys and detected vulnerabilities as values.\n"
        "\nNotes:\n"
        "    - Requires Nmap and NSE vulnerability scripts to be installed.\n"
        "    - Scanning an external IP without permission may be illegal. Use responsibly.\n"
        "    - Running this script may take time, depending on the number of open ports and services.\n"
    )
    return help_text
